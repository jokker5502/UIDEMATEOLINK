<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0066CC">

    <title>UIDE-Link | Bus/Conductor</title>

    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Status Bar -->
    <div class="status-bar">
        <div id="connectionStatus" class="status-indicator">
            <span class="status-dot"></span> Verificando...
        </div>
        <div id="pendingCount" class="pending-count">...</div>
    </div>

    <div class="container-sm" style="margin-top: 80px;">

        <!-- Login View -->
        <div id="loginView" class="page">
            <div class="card fade-in">
                <div class="card-header text-center">
                    <h1 style="color: var(--color-primary);"> UIDE-Link</h1>
                    <p class="text-muted">Panel de Conductor</p>
                </div>

                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Correo</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Contrase帽a</label>
                        <input type="password" id="password" class="form-input" required>
                    </div>

                    <button type="submit" class="btn btn-primary btn-large btn-full">
                        Iniciar Sesi贸n
                    </button>
                </form>
            </div>
        </div>

        <!-- Driver Dashboard -->
        <div id="driverView" class="page hidden">

            <!-- Bus Info Card -->
            <div class="card fade-in"
                style="background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); color: white;">
                <h2 id="busNumber" style="color: white;">Bus #</h2>
                <p id="routeName" style="color: rgba(255,255,255,0.9);">Ruta</p>
            </div>

            <!-- QR Code Display -->
            <div class="card fade-in text-center" style="animation-delay: 0.1s;">
                <h3 class="card-title">C贸digo QR del Bus</h3>
                <p class="text-muted mb-3">Estudiantes deben escanear este c贸digo</p>

                <div id="qrCodeContainer"
                    style="background: white; padding: var(--space-lg); border-radius: var(--radius-lg); display: inline-block;">
                    <canvas id="qrCanvas"></canvas>
                </div>

                <button id="fullscreenBtn" class="btn btn-outline btn-full mt-3">
                     Modo Pantalla Completa
                </button>
            </div>

            <!-- Today's Stats -->
            <div class="card fade-in" style="animation-delay: 0.2s;">
                <div class="card-header">
                    <h3 class="card-title">Estad铆sticas de Hoy</h3>
                </div>

                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-top: var(--space-md);">
                    <div
                        style="text-align: center; padding: var(--space-md); background: var(--color-bg); border-radius: var(--radius-md);">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--color-success);" id="ingressCount">0
                        </div>
                        <div class="text-muted">Ingresos</div>
                    </div>
                    <div
                        style="text-align: center; padding: var(--space-md); background: var(--color-bg); border-radius: var(--radius-md);">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--color-error);" id="egressCount">0
                        </div>
                        <div class="text-muted">Salidas</div>
                    </div>
                </div>

                <div class="mt-3 text-center">
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);"
                        id="currentOccupancy">0</div>
                    <div class="text-muted">Pasajeros a bordo (estimado)</div>
                </div>
            </div>

            <!-- Logout -->
            <div class="text-center mt-4">
                <button id="logoutBtn" class="btn btn-outline">Cerrar Sesi贸n</button>
            </div>
        </div>

    </div>

    <!-- Config -->
    <script>
        window.CONFIG = { API_URL: 'http://localhost:3000' };
    </script>

    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <!-- Scripts -->
    <script src="/js/db.js"></script>
    <script src="/js/sync.js"></script>

    <script>
        let currentDriver = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Register SW
            if ('serviceWorker' in navigator) {
                await navigator.serviceWorker.register('/sw.js');
            }

            await window.DB.init();
            await window.SyncManager.init();

            setupEventListeners();
            await checkAuth();
        });

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
        }

        async function checkAuth() {
            const userData = await window.DB.getUserData();
            if (userData && userData.userType === 'driver') {
                currentDriver = userData;
                showDriverView();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginView').classList.remove('hidden');
            document.getElementById('driverView').classList.add('hidden');
        }

        function showDriverView() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('driverView').classList.remove('hidden');

            loadBusInfo();
            loadStats();
        }

        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${window.CONFIG.API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, userType: 'driver' })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message);

                await window.DB.setUserData(data);
                currentDriver = data;
                showDriverView();

            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function loadBusInfo() {
            try {
                const busId = currentDriver.user.assigned_bus_id;

                const response = await fetch(`${window.CONFIG.API_URL}/api/qr/${busId}`, {
                    headers: { 'Authorization': `Bearer ${currentDriver.token}` }
                });

                const data = await response.json();
                const bus = data.bus;

                document.getElementById('busNumber').textContent = bus.bus_number;
                document.getElementById('routeName').textContent = `Ruta ID: ${bus.route_id}`;

                // Generate QR Code
                const qrCanvas = document.getElementById('qrCanvas');
                QRCode.toCanvas(qrCanvas, bus.qr_code, {
                    width: 300,
                    margin: 2,
                    color: {
                        dark: '#0066CC',
                        light: '#FFFFFF'
                    }
                });

            } catch (error) {
                console.error('Error loading bus info:', error);
            }
        }

        async function loadStats() {
            try {
                const busId = currentDriver.user.assigned_bus_id;
                const today = new Date().toISOString().split('T')[0];

                const response = await fetch(`${window.CONFIG.API_URL}/api/scans/bus/${busId}?date=${today}`, {
                    headers: { 'Authorization': `Bearer ${currentDriver.token}` }
                });

                const data = await response.json();

                const ingress = data.scans.filter(s => s.event_type === 'ingress').length;
                const egress = data.scans.filter(s => s.event_type === 'egress').length;

                document.getElementById('ingressCount').textContent = ingress;
                document.getElementById('egressCount').textContent = egress;
                document.getElementById('currentOccupancy').textContent = data.currentOccupancy || 0;

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function toggleFullscreen() {
            const qrContainer = document.getElementById('qrCodeContainer');

            if (!document.fullscreenElement) {
                qrContainer.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        async function handleLogout() {
            await window.DB.clearUserData();
            currentDriver = null;
            showLogin();
        }

        // Auto-refresh stats every 30 seconds
        setInterval(() => {
            if (currentDriver) {
                loadStats();
            }
        }, 30000);
    </script>
</body>

</html>